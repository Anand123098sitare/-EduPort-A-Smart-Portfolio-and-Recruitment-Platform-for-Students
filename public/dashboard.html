<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - EduPort</title>
    <!-- FIX: Added an inline SVG favicon to prevent the browser from searching for favicon.ico -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="dashboard.css">
  </head>
  <body>
    <nav id="navbar">
      <ul class="navbar-items flexbox-col">
        <li class="navbar-logo flexbox-left">
          <a class="navbar-item-inner flexbox">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              id="Layer_1"
              data-name="Layer 1"
              viewBox="0 0 1438.88 1819.54"
            >
              <polygon
                points="925.79 318.48 830.56 0 183.51 1384.12 510.41 1178.46 925.79 318.48"
              />
              <polygon
                points="1438.88 1663.28 1126.35 948.08 111.98 1586.26 0 1819.54 1020.91 1250.57 1123.78 1471.02 783.64 1663.28 1438.88 1663.28"
              />
            </svg>
          </a>
        </li>
        <li class="navbar-item flexbox-left">
          <a class="navbar-item-inner flexbox-left" href="index.html">
            <div class="navbar-item-inner-icon-wrapper flexbox">
              <ion-icon name="home-outline"></ion-icon>
            </div>
            <span class="link-text">Home</span>
          </a>
        </li>
        <li class="navbar-item flexbox-left">
          <a class="navbar-item-inner flexbox-left" href="projects.html">
            <div class="navbar-item-inner-icon-wrapper flexbox">
              <ion-icon name="folder-open-outline"></ion-icon>
            </div>
            <span class="link-text">Projects</span>
          </a>
        </li>
        <li class="navbar-item flexbox-left">
          <a class="navbar-item-inner flexbox-left" href="dashboard.html">
            <div class="navbar-item-inner-icon-wrapper flexbox">
              <ion-icon name="pie-chart-outline"></ion-icon>
            </div>
            <span class="link-text">Dashboard</span>
          </a>
        </li>
        <li class="navbar-item flexbox-left">
          <a class="navbar-item-inner flexbox-left">
            <div class="navbar-item-inner-icon-wrapper flexbox">
              <ion-icon name="people-outline"></ion-icon>
            </div>
            <span class="link-text">Dev's</span>
          </a>
        </li>
        <li class="navbar-item flexbox-left">
          <a class="navbar-item-inner flexbox-left">
            <div class="navbar-item-inner-icon-wrapper flexbox">
              <ion-icon name="chatbubbles-outline"></ion-icon>
            </div>
            <span class="link-text">Support</span>
          </a>
        </li>
      </ul>
    </nav>

    <div class="page-wrapper">
      <header class="top-bar">
        <div class="header-right">
          <div class="search-bar">
            <ion-icon name="search"></ion-icon>
            <input type="text" placeholder="Search..." />
          </div>
          <div class="user-profile" id="user-profile">
            <img
              src="https://placehold.co/40x40/cccccc/ffffff?text=L"
              alt="User Profile"
            />
            <div class="profile-menu" id="profile-menu">
              <div class="profile-menu-header">
                <p id="profile-name">Loading...</p>
              </div>
              <button id="my-profile-btn">My Profile</button>
              <a href="#">Settings</a>
              <button class="logout-btn" id="logout-btn">Logout</button>
            </div>
          </div>
        </div>
      </header>

      <main id="main-content">
        <div class="main-content-header">
            <h1>Overview</h1>
            <button class="create-project-btn" id="create-project-btn">Create New Project</button>
        </div>
        <section class="project-grid" id="project-grid">
          <!-- Project cards will be dynamically inserted here -->
        </section>
      </main>
    </div>

    <!-- Create Project Modal -->
    <div id="project-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" id="project-modal-close">&times;</button>
        <div class="modal-body">
            <h2>Create a New Project</h2>
            <form id="project-form">
                <div class="form-group">
                    <label for="title">Project Title</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" rows="4" required></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="create-project-btn cancel-btn" id="cancel-create-btn">Cancel</button>
                    <button type="submit" class="create-project-btn">Save Project</button>
                </div>
            </form>
        </div>
      </div>
    </div>

    <!-- My Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
          <button class="modal-close" id="profile-modal-close">&times;</button>
          <div class="modal-body">
              <h2>My Profile</h2>
              <form id="profile-form">
                  <div class="profile-picture-upload">
                      <img src="https://placehold.co/80x80/cccccc/ffffff?text=P" alt="Profile Preview" class="profile-picture-preview" id="profile-picture-preview">
                      <div>
                          <label for="profile-picture-input">Upload Photo</label>
                          <input type="file" id="profile-picture-input" accept="image/png, image/jpeg">
                          <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">PNG or JPG, max 2MB.</p>
                      </div>
                  </div>
                  <div class="form-group">
                      <label for="profile-name-input">Full Name</label>
                      <input type="text" id="profile-name-input" required>
                  </div>
                  <div class="modal-actions">
                      <button type="button" class="create-project-btn cancel-btn" id="cancel-profile-btn">Cancel</button>
                      <button type="submit" class="create-project-btn">Save Changes</button>
                  </div>
              </form>
          </div>
        </div>
      </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Part 1: Handle Token on Page Load ---
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                localStorage.setItem('token', tokenFromUrl);
                window.history.replaceState({}, document.title, "dashboard.html");
            }

            // --- Part 2: Verify Token and Protect the Page ---
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // --- Part 3: Element References ---
            const userProfileImg = document.querySelector('#user-profile img');
            const userProfileName = document.getElementById('profile-name');
            const userProfile = document.getElementById('user-profile');
            const profileMenu = document.getElementById('profile-menu');
            const logoutBtn = document.getElementById('logout-btn');
            const projectGrid = document.getElementById('project-grid');
            
            // Modals
            const createProjectModal = document.getElementById('project-modal');
            const profileModal = document.getElementById('profile-modal');
            
            // Buttons
            const myProfileBtn = document.getElementById('my-profile-btn');
            const createProjectBtn = document.getElementById('create-project-btn');
            
            // --- Profile Menu Dropdown Logic ---
            userProfile.addEventListener('click', (e) => {
                e.stopPropagation();
                profileMenu.classList.toggle('show');
            });
            window.addEventListener('click', () => {
                if (profileMenu.classList.contains('show')) {
                    profileMenu.classList.remove('show');
                }
            });

            // --- Logout Logic ---
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
            });
            
            // --- API Call to Fetch User Profile Data ---
            const loadUserProfile = async () => {
                try {
                    const res = await fetch('http://localhost:3000/api/users/me', {
                        headers: { 'x-auth-token': token }
                    });
                    if (!res.ok) throw new Error('Could not fetch user profile.');
                    
                    const user = await res.json();
                    
                    if (user.profilePictureUrl) {
                        const imageUrl = user.profilePictureUrl.startsWith('http') ? user.profilePictureUrl : `http://localhost:3000${user.profilePictureUrl}`;
                        userProfileImg.src = imageUrl;
                    } else {
                        const initial = (user.name || user.email || 'U').charAt(0).toUpperCase();
                        userProfileImg.src = `https://placehold.co/40x40/1877f2/ffffff?text=${initial}`;
                    }
                    
                    userProfileName.textContent = user.name || user.email;

                    document.getElementById('profile-name-input').value = user.name || '';
                    document.getElementById('profile-picture-preview').src = userProfileImg.src;

                } catch (error) {
                    console.error(error);
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                }
            };

            // --- API Call to Fetch and Display Projects ---
            const fetchAndDisplayProjects = async () => {
                try {
                    const res = await fetch('http://localhost:3000/api/projects', {
                        headers: { 'x-auth-token': token }
                    });
                    if (!res.ok) throw new Error('Failed to fetch projects');

                    const projects = await res.json();
                    projectGrid.innerHTML = '';
                    
                    if (projects.length === 0) {
                        projectGrid.innerHTML = '<p style="color: var(--text-secondary);">You have not created any projects yet. Click "Create New Project" to get started!</p>';
                    } else {
                        projects.forEach(project => {
                            const card = document.createElement('div');
                            card.className = 'project-card';
                            card.innerHTML = `
                                <img class="project-card-image" src="https://placehold.co/600x400/e9ebee/333333?text=Project" alt="${project.title}">
                                <div class="project-card-content">
                                    <h3>${project.title}</h3>
                                    <p>${project.description.substring(0, 100)}...</p>
                                </div>
                            `;
                            projectGrid.appendChild(card);
                        });
                    }
                } catch (err) {
                    console.error(err);
                    projectGrid.innerHTML = '<p style="color: red;">Could not load projects. Please try again later.</p>';
                }
            };

            // --- Modal Opening/Closing Logic ---
            const openModal = (modal) => modal.classList.add('show');
            const closeModal = (modal) => modal.classList.remove('show');

            createProjectBtn.addEventListener('click', () => openModal(createProjectModal));
            myProfileBtn.addEventListener('click', () => openModal(profileModal));

            document.getElementById('project-modal-close').addEventListener('click', () => closeModal(createProjectModal));
            document.getElementById('cancel-create-btn').addEventListener('click', () => closeModal(createProjectModal));

            document.getElementById('profile-modal-close').addEventListener('click', () => closeModal(profileModal));
            document.getElementById('cancel-profile-btn').addEventListener('click', () => closeModal(profileModal));

            // --- Handle Create Project Form Submission ---
            document.getElementById('project-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = document.getElementById('title').value;
                const description = document.getElementById('description').value;
                try {
                    const res = await fetch('http://localhost:3000/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-auth-token': token },
                        body: JSON.stringify({ title, description })
                    });
                    if (!res.ok) throw new Error('Failed to create project');
                    closeModal(createProjectModal);
                    e.target.reset();
                    fetchAndDisplayProjects();
                } catch (err) {
                    console.error(err);
                    alert('Error creating project.');
                }
            });

            // --- Handle Profile Update ---
            const profilePictureInput = document.getElementById('profile-picture-input');
            const profilePicturePreview = document.getElementById('profile-picture-preview');

            profilePictureInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        profilePicturePreview.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('profile-name-input').value;
                const file = profilePictureInput.files[0];
                
                const formData = new FormData();
                formData.append('name', name);
                if (file) {
                    formData.append('profilePicture', file);
                }

                try {
                    const res = await fetch('http://localhost:3000/api/users/me', {
                        method: 'PUT',
                        headers: { 'x-auth-token': token },
                        body: formData
                    });
                    
                    if (!res.ok) {
                        const errorData = await res.json().catch(() => ({ message: 'Failed to update profile' }));
                        throw new Error(errorData.message);
                    }

                    closeModal(profileModal);
                    loadUserProfile(); // Refresh the profile display

                } catch (err) {
                    console.error(err);
                    alert(`Error updating profile: ${err.message}`);
                }
            });

            // --- Initial Load ---
            Promise.all([
                loadUserProfile(),
                fetchAndDisplayProjects()
            ]);
        });
    </script>
    <script
      type="module"
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"
    ></script>
  </body>
</html>
