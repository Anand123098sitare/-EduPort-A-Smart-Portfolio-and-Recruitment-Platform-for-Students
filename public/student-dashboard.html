<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - EduPort</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Festive&family=Hanalei&family=Londrina+Shadow&family=Oswald:wght@200..700&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="dashboard.css">
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar Navigation -->
      <nav class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <div class="logo-icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 12l2 2 4-4"/>
              </svg>
            </div>
            <span class="logo-text">Edu</span>
          </div>
        </div>
        
        <div class="sidebar-menu">
          <div class="menu-section">
            <ul class="menu-items">
              <li class="menu-item">
                <a href="index.html" class="menu-link">
                  <ion-icon name="home-outline"></ion-icon>
                  <span>Home</span>
                </a>
              </li>
              <li class="menu-item active">
                <a href="student-dashboard.html" class="menu-link">
                  <ion-icon name="grid-outline"></ion-icon>
                  <span>Dashboard</span>
                </a>
              </li>
              <li class="menu-item">
                <a href="create-project.html" class="menu-link">
                  <ion-icon name="add-circle-outline"></ion-icon>
                  <span>Add Project</span>
                </a>
              </li>
              <li class="menu-item">
                <a href="profile.html" class="menu-link">
                  <ion-icon name="person-outline"></ion-icon>
                  <span>Profile</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Top Header Bar -->
        <header class="top-header">
          <div class="header-left">
            <button class="sidebar-toggle" id="sidebar-toggle">
              <ion-icon name="menu-outline"></ion-icon>
            </button>
            <div class="page-title">
              <h1 id="main-title">Student Dashboard</h1>
              <p class="page-subtitle">Manage your projects and portfolio</p>
            </div>
          </div>
          
          <div class="header-right">
            <div class="header-actions">
              <div class="role-indicator student-role" id="role-indicator">
                <ion-icon name="person-outline" id="role-icon"></ion-icon>
                <span id="role-text">Student</span>
              </div>
              
              <div class="profile-section">
                <div class="profile-dropdown" id="profile-dropdown">
                  <div class="profile-trigger" id="profile-trigger">
                    <div class="profile-avatar">
                      <img src="https://ui-avatars.com/api/?name=Student&background=667eea&color=fff" alt="Profile" id="profile-image">
                    </div>
                    <div class="profile-info">
                      <span class="profile-name" id="profile-name">Loading...</span>
                      <span class="profile-email" id="profile-email">Loading...</span>
                    </div>
                    <ion-icon name="chevron-down-outline" class="dropdown-arrow"></ion-icon>
                  </div>
                  
                  <div class="dropdown-menu" id="dropdown-menu">
                    <a href="profile.html" class="dropdown-item">
                      <ion-icon name="person-outline"></ion-icon>
                      <span>My Profile</span>
                    </a>
                    <button class="dropdown-item" id="logout-btn">
                      <ion-icon name="log-out-outline"></ion-icon>
                      <span>Log Out</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Dashboard Content -->
        <div class="dashboard-content">
          <!-- Stats Cards -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">
                <ion-icon name="folder-outline"></ion-icon>
              </div>
              <div class="stat-content">
                <h3 id="total-projects">0</h3>
                <p>My Projects</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <ion-icon name="thumbs-up-outline"></ion-icon>
              </div>
              <div class="stat-content">
                <h3 id="total-upvotes">0</h3>
                <p>Total Upvotes</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <ion-icon name="eye-outline"></ion-icon>
              </div>
              <div class="stat-content">
                <h3 id="total-views">0</h3>
                <p>Profile Views</p>
              </div>
            </div>
            
            <div class="stat-card">
              <div class="stat-icon">
                <ion-icon name="trophy-outline"></ion-icon>
              </div>
              <div class="stat-content">
                <h3 id="total-achievements">0</h3>
                <p>Achievements</p>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions">
            <h2>Quick Actions</h2>
            <div class="action-buttons">
              <a href="create-project.html" class="action-btn primary">
                <ion-icon name="add-circle-outline"></ion-icon>
                <span>Create New Project</span>
              </a>
              <a href="profile.html" class="action-btn secondary">
                <ion-icon name="person-outline"></ion-icon>
                <span>Edit Profile</span>
              </a>
            </div>
          </div>

          <!-- My Projects Section -->
          <div class="projects-section">
            <div class="section-header">
              <h2>My Projects</h2>
              <a href="create-project.html" class="btn-add-project">
                <ion-icon name="add-outline"></ion-icon>
                Add Project
              </a>
            </div>
            
            <div class="projects-grid" id="projects-grid">
              <!-- Projects will be loaded here -->
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script>
      // Student Dashboard JavaScript
      document.addEventListener('DOMContentLoaded', async function() {
        const token = localStorage.getItem('token');
        
        // Role validation - ensure this is a student
        const userRole = localStorage.getItem('userRole');
        if (!token) {
          window.location.href = 'role-selection.html';
          return;
        }
        
        if (userRole !== 'student') {
          showNotification('Access denied. Students only.', 'error');
          setTimeout(() => {
            localStorage.clear();
            window.location.href = 'role-selection.html';
          }, 2000);
          return;
        }

        // Initialize dashboard
        await loadUserProfile();
        await loadStudentProjects();
        setupEventListeners();
        
        showNotification('Welcome to your Student Dashboard!', 'success');
      });

      // Load user profile data
      async function loadUserProfile() {
        try {
          const token = localStorage.getItem('token');
          const response = await fetch('http://localhost:3000/api/users/me', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const user = await response.json();
            document.getElementById('profile-name').textContent = user.name || 'Student';
            document.getElementById('profile-email').textContent = user.email || '';
            
            if (user.profilePicture) {
              document.getElementById('profile-image').src = user.profilePicture;
            }
          }
        } catch (error) {
          console.error('Error loading profile:', error);
        }
      }

      // Load student's projects
      async function loadStudentProjects() {
        try {
          const token = localStorage.getItem('token');
          // Use the community endpoint and filter for user's projects
          const response = await fetch('http://localhost:3000/api/projects/community', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.ok) {
            const allProjects = await response.json();
            
            // Get current user ID from token to filter projects
            const userId = getUserIdFromToken(token);
            const userProjects = userId ? allProjects.filter(project => project.user === userId) : [];
            
            displayProjects(userProjects);
            updateStats(userProjects);
          } else {
            console.error('Failed to load projects:', response.status);
            showNotification('Failed to load projects', 'error');
          }
        } catch (error) {
          console.error('Error loading projects:', error);
          showNotification('Error loading projects', 'error');
        }
      }
      
      // Helper function to extract user ID from JWT token
      function getUserIdFromToken(token) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          return payload.user.id;
        } catch (error) {
          console.error('Error parsing token:', error);
          return null;
        }
      }

      // Display projects in grid
      function displayProjects(projects) {
        const projectsGrid = document.getElementById('projects-grid');
        
        if (projects.length === 0) {
          projectsGrid.innerHTML = `
            <div class="empty-state">
              <ion-icon name="folder-open-outline"></ion-icon>
              <h3>No Projects Yet</h3>
              <p>Create your first project to get started!</p>
              <a href="create-project.html" class="btn-primary">Create Project</a>
            </div>
          `;
          return;
        }
        
        projectsGrid.innerHTML = projects.map(project => `
          <div class="project-card">
            <div class="project-image">
              <img src="${project.screenshotUrl || 'https://placehold.co/300x200/667eea/ffffff?text=Project'}" alt="${project.projectName}">
            </div>
            <div class="project-content">
              <h3>${project.projectName}</h3>
              <p>${project.projectDescription}</p>
              <div class="project-tech">
                <span class="tech-badge">${project.techUsed}</span>
              </div>
              <div class="project-stats">
                <span><ion-icon name="thumbs-up-outline"></ion-icon> ${project.upvotes || 0}</span>
                <span><ion-icon name="eye-outline"></ion-icon> ${project.views || 0}</span>
              </div>
              <div class="project-actions">
                ${project.projectUrl ? `<a href="${project.projectUrl}" target="_blank" class="btn-view">View</a>` : ''}
                ${project.githubUrl ? `<a href="${project.githubUrl}" target="_blank" class="btn-github">GitHub</a>` : ''}
              </div>
            </div>
          </div>
        `).join('');
      }

      // Update dashboard stats
      function updateStats(projects) {
        const totalProjects = projects.length;
        const totalUpvotes = projects.reduce((sum, project) => sum + (project.upvotes || 0), 0);
        
        document.getElementById('total-projects').textContent = totalProjects;
        document.getElementById('total-upvotes').textContent = totalUpvotes;
      }

      // Setup event listeners
      function setupEventListeners() {
        // Profile dropdown
        const profileTrigger = document.getElementById('profile-trigger');
        const dropdownMenu = document.getElementById('dropdown-menu');
        
        if (profileTrigger && dropdownMenu) {
          profileTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
          });
          
          document.addEventListener('click', () => {
            dropdownMenu.classList.remove('show');
          });
          
          dropdownMenu.addEventListener('click', (e) => {
            e.stopPropagation();
          });
        }
        
        // Logout
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'index.html';
          });
        }
        
        // Sidebar toggle
        const sidebarToggle = document.getElementById('sidebar-toggle');
        if (sidebarToggle) {
          sidebarToggle.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('collapsed');
          });
        }
      }

      // Notification system
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification);
            }
          }, 300);
        }, 3000);
      }
    </script>
  </body>
</html>
